# Обработка транзакций

В этом разделе подробно описаны функции модуля `processing.py` для работы с финансовыми транзакциями.

## Обзор модуля processing

Модуль `processing.py` предоставляет функции для фильтрации, сортировки и форматирования финансовых транзакций. Он позволяет эффективно работать с большими объемами данных и извлекать нужную информацию.

## Функции модуля

### filter_by_state

Функция `filter_by_state` фильтрует список словарей по значению ключа 'state'.

#### Синтаксис

```python
def filter_by_state(transactions: List[Dict[str, Any]], state: str = "EXECUTED") -> List[Dict[str, Any]]
```

#### Параметры

- `transactions`: Список словарей для фильтрации
- `state`: Значение состояния для фильтрации (по умолчанию 'EXECUTED')

#### Возвращаемое значение

Новый список, содержащий только словари с указанным значением состояния.

#### Примеры использования

```python
from src.processing import filter_by_state

# Фильтрация транзакций по состоянию "EXECUTED"
executed_transactions = filter_by_state(transactions, "EXECUTED")

# Фильтрация транзакций по состоянию "PENDING"
pending_transactions = filter_by_state(transactions, "PENDING")

# Фильтрация транзакций по состоянию "CANCELED"
canceled_transactions = filter_by_state(transactions, "CANCELED")
```

#### Особенности реализации

- Использует безопасный доступ к ключу через метод `.get()` для избежания ошибок `KeyError`
- Создает новый список с отфильтрованными транзакциями
- Не изменяет исходный список транзакций

### sort_by_date

Функция `sort_by_date` сортирует список словарей по ключу 'date' в формате ISO.

#### Синтаксис

```python
def sort_by_date(transactions: List[Dict[str, Any]], is_reverse_order: bool = True) -> List[Dict[str, Any]]
```

#### Параметры

- `transactions`: Список словарей, содержащих ключи 'date'
- `is_reverse_order`: Порядок сортировки (по умолчанию True - по убыванию)

#### Возвращаемое значение

Новый список, отсортированный по дате с возможностью обратного порядка.

#### Примеры использования

```python
from src.processing import sort_by_date

# Сортировка транзакций по дате (от новых к старым)
sorted_transactions = sort_by_date(transactions)

# Сортировка транзакций по дате (от старых к новым)
sorted_asc = sort_by_date(transactions, is_reverse_order=False)
```

#### Особенности реализации

- Преобразует строки с датами в объекты `datetime` для корректной сортировки
- Использует функцию `get_date` из модуля `widget` для форматирования дат
- Создает новый отсортированный список, не изменяя исходный

## Примеры комплексной обработки

### Пример 1: Фильтрация и сортировка транзакций

```python
from src.processing import filter_by_state, sort_by_date

# Исходные данные
transactions = [
    {"id": 1, "state": "EXECUTED", "date": "2023-12-25T15:30:45.123456", "amount": 100.0},
    {"id": 2, "state": "PENDING", "date": "2023-12-26T10:15:30.654321", "amount": 200.0},
    {"id": 3, "state": "EXECUTED", "date": "2023-12-24T18:45:12.987654", "amount": 150.0},
    {"id": 4, "state": "CANCELED", "date": "2023-12-27T09:20:05.555555", "amount": 300.0},
    {"id": 5, "state": "EXECUTED", "date": "2023-12-23T22:10:33.777777", "amount": 250.0}
]

# Фильтрация выполненных транзакций
executed_transactions = filter_by_state(transactions, "EXECUTED")

# Сортировка по дате (от новых к старым)
sorted_transactions = sort_by_date(executed_transactions)

# Вывод результатов
for transaction in sorted_transactions:
    print(f"ID: {transaction['id']}, Дата: {transaction['date']}, Сумма: {transaction['amount']}")
```

### Пример 2: Комплексная обработка с маскировкой данных

```python
from src.processing import filter_by_state, sort_by_date
from src.widget import mask_account_card, get_date

# Функция для форматирования транзакции
def format_transaction(transaction):
    # Маскирование данных
    from_account = mask_account_card(transaction.get("from", ""))
    to_account = mask_account_card(transaction.get("to", ""))

    # Форматирование даты
    date = get_date(transaction.get("date", ""))

    # Форматирование суммы
    amount = transaction.get("operationAmount", {}).get("amount", "")
    currency = transaction.get("operationAmount", {}).get("currency", {}).get("code", "")

    return {
        "date": date,
        "description": transaction.get("description", ""),
        "from": from_account,
        "to": to_account,
        "amount": f"{amount} {currency}"
    }

# Фильтрация и сортировка
executed_transactions = filter_by_state(transactions, "EXECUTED")
sorted_transactions = sort_by_date(executed_transactions)

# Форматирование результатов
formatted_transactions = [format_transaction(tx) for tx in sorted_transactions]

# Вывод результатов
for tx in formatted_transactions:
    print(f"{tx['date']} {tx['description']}")
    print(f"{tx['from']} -> {tx['to']}")
    print(f"Сумма: {tx['amount']}")
    print()
```

## Интеграция с другими модулями

Модуль `processing.py` тесно интегрирован с другими модулями библиотеки:

- Использует функцию `get_date` из модуля `widget` для форматирования дат
- Может использоваться совместно с функциями маскировки из модулей `masks` и `widget`
- Комбинируется с генераторами из модуля `generators` для эффективной обработки данных

## Рекомендации по использованию

1. **Фильтруйте данные перед сортировкой** - это уменьшит объем данных для сортировки и повысит производительность
2. **Используйте безопасный доступ к ключам** - при работе с реальными данными не все поля могут присутствовать в каждой транзакции
3. **Комбинируйте с генераторами** - для обработки больших объемов данных используйте генераторы из модуля `generators`
4. **Кэшируйте результаты** - при многократном использовании одних и тех же данных сохраняйте результаты фильтрации и сортировки
