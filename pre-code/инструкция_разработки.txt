ПОШАГОВАЯ ИНСТРУКЦИЯ ПО РАЗРАБОТКЕ НОВОГО ФУНКЦИОНАЛА
=====================================================

ЗАДАНИЕ: Реализация функций для работы с JSON-файлами транзакций и конвертации валют
====================================================================================

ШАГ 1: Создание модуля utils для работы с JSON-файлами
-------------------------------------------------------

1.1. Создать директорию src/utils/ (если её нет) или добавить файл utils.py в директорию src/

1.2. Создать файл src/utils.py (или src/utils/__init__.py) со следующей функцией:

    Функция: load_transactions_from_json(file_path: str) -> list[dict]
    
    Описание:
    - Принимает путь до JSON-файла
    - Читает содержимое файла
    - Парсит JSON и возвращает список словарей с транзакциями
    - Обрабатывает следующие случаи:
      * Файл не найден -> возвращает пустой список []
      * Файл пустой -> возвращает пустой список []
      * Файл содержит не список (например, словарь) -> возвращает пустой список []
      * Файл содержит валидный список -> возвращает этот список
    
    Импорты:
    - import json
    - import os
    - from typing import Any
    
    Логика:
    1. Проверить существование файла через os.path.exists()
    2. Если файл не существует -> return []
    3. Открыть файл в режиме чтения
    4. Прочитать содержимое
    5. Если файл пустой -> return []
    6. Попытаться распарсить JSON через json.loads()
    7. Проверить, что результат является списком (isinstance(result, list))
    8. Если не список -> return []
    9. Вернуть список транзакций

1.3. Добавить типизацию:
    - Использовать type hints для всех параметров и возвращаемых значений
    - Использовать list[dict[str, Any]] для возвращаемого типа
    - Обработать возможные исключения (FileNotFoundError, json.JSONDecodeError)


ШАГ 2: Скачивание файла operations.json
-----------------------------------------

2.1. Скачать файл operations.json по ссылке из задания

2.2. Поместить файл operations.json в директорию data/ в корне проекта

2.3. Проверить, что файл успешно загружен и содержит валидный JSON


ШАГ 3: Создание модуля external_api для конвертации валют
-----------------------------------------------------------

3.1. Создать файл src/external_api.py

3.2. Реализовать функцию конвертации валют:

    Функция: convert_currency_to_rubles(transaction: dict) -> float
    
    Описание:
    - Принимает транзакцию (словарь) с полями:
      * operationAmount.amount - сумма транзакции
      * operationAmount.currency.code - код валюты (RUB, USD, EUR)
    - Если валюта RUB -> возвращает сумму как есть
    - Если валюта USD или EUR -> делает запрос к API для получения курса
    - Конвертирует сумму в рубли и возвращает float
    
    Импорты:
    - import os
    - import requests
    - from typing import Any
    - from dotenv import load_dotenv
    
    Логика:
    1. Загрузить переменные окружения через load_dotenv()
    2. Получить API ключ из переменной окружения (например, EXCHANGE_RATE_API_KEY)
    3. Извлечь из транзакции:
       - amount = transaction["operationAmount"]["amount"]
       - currency = transaction["operationAmount"]["currency"]["code"]
    4. Если currency == "RUB":
       - Вернуть float(amount)
    5. Если currency == "USD" или "EUR":
       - Сформировать URL для API запроса:
         https://api.apilayer.com/exchangerates_data/convert
       - Параметры запроса:
         * from: currency (USD или EUR)
         * to: "RUB"
         * amount: amount
       - Заголовки:
         * apikey: значение из переменной окружения
       - Выполнить GET или POST запрос через requests
       - Из ответа извлечь поле "result" (конвертированная сумма)
       - Вернуть float(result)
    6. Обработать возможные ошибки:
       - requests.RequestException
       - KeyError (если структура транзакции неверна)
       - ValueError (при конвертации в float)

3.3. Добавить типизацию:
    - Использовать type hints для всех параметров и возвращаемых значений
    - Использовать dict[str, Any] для типа транзакции
    - Указать возвращаемый тип float


ШАГ 4: Настройка переменных окружения
--------------------------------------

4.1. Создать файл .env в корне проекта со следующим содержимым:

    EXCHANGE_RATE_API_KEY=your_api_key_here

4.2. Создать файл .env.example (шаблон) в корне проекта:

    EXCHANGE_RATE_API_KEY=

    Примечание: Этот файл будет закоммичен в репозиторий, но без реального ключа

4.3. Убедиться, что .env добавлен в .gitignore (чтобы не попадал в репозиторий)

4.4. Получить API ключ:
    - Зарегистрироваться на https://apilayer.com/exchangerates_data-api
    - Получить бесплатный API ключ
    - Добавить ключ в файл .env


ШАГ 5: Установка зависимостей
-------------------------------

5.1. Проверить, что в pyproject.toml или requirements.txt есть:
    - requests (для работы с API)
    - python-dotenv (для работы с .env файлами)

5.2. Если зависимостей нет, добавить их:
    - Для pyproject.toml: добавить в dependencies
    - Для requirements.txt: добавить строки requests и python-dotenv

5.3. Установить зависимости:
    - poetry install (если используется Poetry)
    - pip install -r requirements.txt (если используется pip)


ШАГ 6: Написание тестов
------------------------

6.1. Создать файл tests/test_utils.py для тестирования функции load_transactions_from_json:

    Тесты должны покрывать:
    - Успешное чтение валидного JSON-файла со списком
    - Чтение несуществующего файла (должен вернуть [])
    - Чтение пустого файла (должен вернуть [])
    - Чтение файла с не-списком, например словарем (должен вернуть [])
    - Чтение файла с невалидным JSON (должен вернуть [] или обработать ошибку)
    
    Использовать:
    - pytest для запуска тестов
    - Временные файлы через tempfile для создания тестовых JSON-файлов
    - Фикстуры для подготовки тестовых данных

6.2. Создать файл tests/test_external_api.py для тестирования функции convert_currency_to_rubles:

    Тесты должны покрывать:
    - Конвертацию RUB (должна вернуть сумму как есть)
    - Конвертацию USD (должна сделать запрос к API и вернуть конвертированную сумму)
    - Конвертацию EUR (должна сделать запрос к API и вернуть конвертированную сумму)
    - Обработку ошибок API (например, неправильный ключ, недоступность API)
    - Обработку неверной структуры транзакции
    
    Использовать:
    - unittest.mock.patch для мокирования requests.get/requests.post
    - unittest.mock.Mock для создания фиктивных ответов API
    - Пример структуры мока:
      with patch('src.external_api.requests.get') as mock_get:
          mock_response = Mock()
          mock_response.json.return_value = {"result": 100.0}
          mock_get.return_value = mock_response
          # тест функции

6.3. Пример структуры теста с Mock:

    from unittest.mock import patch, Mock
    import pytest
    from src.external_api import convert_currency_to_rubles
    
    def test_convert_usd_to_rubles():
        transaction = {
            "operationAmount": {
                "amount": "100.0",
                "currency": {"code": "USD"}
            }
        }
        
        with patch('src.external_api.requests.get') as mock_get:
            mock_response = Mock()
            mock_response.json.return_value = {"result": 7500.0}
            mock_get.return_value = mock_response
            
            result = convert_currency_to_rubles(transaction)
            assert result == 7500.0
            mock_get.assert_called_once()


ШАГ 7: Типизация кода
----------------------

7.1. Добавить type hints во все функции:
    - Параметры функций должны иметь явные типы
    - Возвращаемые значения должны иметь явные типы
    - Использовать типы из модуля typing:
      * list, dict, Optional, Any, Union

7.2. Примеры типизации:

    from typing import Any
    
    def load_transactions_from_json(file_path: str) -> list[dict[str, Any]]:
        ...
    
    def convert_currency_to_rubles(transaction: dict[str, Any]) -> float:
        ...

7.3. Запустить mypy для проверки типов:
    - mypy src/utils.py
    - mypy src/external_api.py
    - mypy . (для проверки всего проекта)

7.4. Исправить все ошибки mypy:
    - Добавить недостающие type hints
    - Использовать Optional для значений, которые могут быть None
    - Использовать Union для значений с несколькими возможными типами
    - Добавить type: ignore комментарии только в крайних случаях


ШАГ 8: Проверка и тестирование
-------------------------------

8.1. Запустить все тесты:
    pytest tests/test_utils.py
    pytest tests/test_external_api.py
    pytest (для всех тестов)

8.2. Проверить покрытие кода:
    pytest --cov=src --cov-report=html
    Открыть htmlcov/index.html для просмотра покрытия

8.3. Запустить линтеры:
    flake8 src/utils.py src/external_api.py
    black src/utils.py src/external_api.py
    isort src/utils.py src/external_api.py
    mypy src/utils.py src/external_api.py

8.4. Проверить работу функций вручную:
    - Создать тестовый скрипт для проверки load_transactions_from_json
    - Создать тестовый скрипт для проверки convert_currency_to_rubles
    - Убедиться, что все работает корректно


ШАГ 9: Документация и финализация
-----------------------------------

9.1. Добавить docstrings к функциям:
    - Описание функции
    - Описание параметров
    - Описание возвращаемого значения
    - Примеры использования (опционально)

9.2. Обновить README.md (если необходимо):
    - Добавить описание новых функций
    - Добавить примеры использования

9.3. Убедиться, что .env.example добавлен в репозиторий
    - .env должен быть в .gitignore
    - .env.example должен быть закоммичен

9.4. Проверить, что все файлы на месте:
    - src/utils.py (или src/utils/__init__.py)
    - src/external_api.py
    - data/operations.json
    - .env.example
    - tests/test_utils.py
    - tests/test_external_api.py

